<!DOCTYPE HTML>
<html>
  <head>
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"> </script>
    <script src="highcharts.js"></script>

    <link rel="stylesheet" href="bootstrap.min.css">
  </head>
  <body>
    <style>
      .dice-roll{
        width: 50px;
        margin: 10px;
      }
      .dice-roll > h3{
        margin-top: 10px;
      }

    </style>

    <nav class="navbar navbar-default" role="navigation">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <span class="navbar-brand" href="#">Dice Roll Stats</span>
        <ul class="nav navbar-nav">
          <li><a id="new-game" href="#">New Game</a></li>
        </ul>
      </div>
    </nav>

    <div class="row">
      <div id="chart" style="width:95%; padding-left: 10px"></div>
    </div>
    <h3 id="enter-prompt">Enter your dice roll:</h3>
    <div class="col-sm-11">
      <div class="col-sm-1 col-sm-offset-1">
        <button class="btn btn-info btn-large dice-roll" value="2" type="button"><h3>2</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="3" type="button"><h3>3</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="4" type="button"><h3>4</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="5" type="button"><h3>5</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="6" type="button"><h3>6</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="7" type="button"><h3>7</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="8" type="button"><h3>8</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="9" type="button"><h3>9</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="10" type="button"><h3>10</h3></button>      
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="11" type="button"><h3>11</h3></button>      
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="12" type="button"><h3>12</h3></button>      
      </div>
    </div>


    <script>
      var allRolls = [];
      var aggregatedRolls = [];
      var rootRef = new Firebase('https://catancount.firebaseio.com/');
      var gameCountRef = rootRef.child('game_count');
      var usersRef = rootRef.child('users');
      var gamesRef = null; //usersRef.child('games');
      var rollsRef = null; // gamesRef.child('rolls');
      var hasLoaded = false;
      var game_count = 1;


      function numberOfOccurrences(arr, num){
        count = 0;

        for (var i = 0; i < arr.length; i++){
          if (arr[i] == num){
            count++;
          }
        }

        return count;
      }

      function getExpectedCount(number, totalRolls){
        rollPercentages = [2.7777, 5.5555, 8.3333, 11.1111, 13.8888, 16.6666, 13.8888, 11.1111, 8.3333, 5.5555, 2.7777]
        for(var i = 0; i < rollPercentages.length; i++){
          rollPercentages[i] = rollPercentages[i] / 100;
        }

        return Math.round((rollPercentages[number - 2] * totalRolls) * 100) / 100;
      }

      function getAggregatedCounts(allDiceRolls){
        var actuals = [];
        var expecteds = [];

        for (var i = 0; i < 11; i++){
          roll = i + 2;
          actual = numberOfOccurrences(allDiceRolls, roll);
          actuals.push(actual);

          expected = getExpectedCount(roll, allDiceRolls.length)
          expecteds.push(expected);
        }

        return {actuals: actuals, expecteds: expecteds};
      }

      function drawChart(hasLoaded) {
        console.log(allRolls);
        if (allRolls.length == 0){
          $('#enter-prompt').show();  
          $('#chart').hide();  
        } else {
          $('#enter-prompt').hide();  
          $('#chart').show();  
        }

        if (!hasLoaded){
          return;
        }

        agg = getAggregatedCounts(allRolls);

        $('#chart').highcharts({
          chart: {
              type: 'column'
          },
          title: {
              text: 'Dice Rolls: Actual vs Expected'
          },
          xAxis: {
              categories: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
          },
          yAxis: {
              title: {
                  text: 'Rolls'
              }
          },
          colors: [
             '#2f7ed8', 
             '#a6c96a'
          ],
          plotOptions: {
              column: {
                  dataLabels: {
                      enabled: true
                  },
                  enableMouseTracking: false
              }
          },
          series: [{
              name: 'Actual',
              data: agg.actuals,
              backgroundColor: '#2DD62D'
          }, {
              name: 'Expected',
              data: agg.expecteds
          }]
        });
      }

      function startNewGame(){
        allRolls = [];
        gameCountRef.set(game_count + 1);  
        console.log(game_count + 1);
        gamesRef = usersRef.child('games').child(game_count + 1);
        rollsRef = gamesRef.child('rolls');

        rollsRef.on('value', function(snapshot) {
          hasLoaded = true;
          drawChart(hasLoaded);
        });

        rollsRef.on('child_added', function(snapshot) {
          var msgData = snapshot.val();
          $('#output').append(msgData + " ");
          allRolls.push(msgData);
        });

        drawChart(true);
      }

      gameCountRef.on('value', function(snapshot) {
        if(snapshot.val() != null) {
          game_count = snapshot.val();
        }
      });


      $('.dice-roll').click(function() {
        if (allRolls.length == 0){
          startNewGame();
        }
        _this = $(this);
        val = _this.val();
        rollsRef.push(val);
      });

      $('#new-game').click(function() {
        startNewGame();
      });

    </script>
  </body>
</html>
