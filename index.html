<!DOCTYPE HTML>
<html>
  <head>
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"> </script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
  </head>
  <body>
    <style>
      .dice-roll{
        width: 50px;
      }
    </style>
    <button class="dice-roll" value="2" type="button"><h3>2</h3></button>
    <button class="dice-roll" value="3" type="button"><h3>3</h3></button>
    <button class="dice-roll" value="4" type="button"><h3>4</h3></button>
    <button class="dice-roll" value="5" type="button"><h3>5</h3></button>
    <button class="dice-roll" value="6" type="button"><h3>6</h3></button>
    <button class="dice-roll" value="7" type="button"><h3>7</h3></button>
    <button class="dice-roll" value="8" type="button"><h3>8</h3></button>
    <button class="dice-roll" value="9" type="button"><h3>9</h3></button>
    <button class="dice-roll" value="10" type="button"><h3>10</h3></button>
    <button class="dice-roll" value="11" type="button"><h3>11</h3></button>
    <button class="dice-roll" value="12" type="button"><h3>12</h3></button>

    <div id="chart" style="width:100%; height:400px;"></div>

    <script>
      var allRolls = [];
      var aggregatedRolls = [];
      var high = 12;

      function numberOfOccurrences(arr, num){
        count = 0;

        for (var i = 0; i < arr.length; i++){
          if (arr[i] == num){
            count++;
          }
        }

        return count;
      }

      function getExpectedCount(number, totalRolls){
        rollPercentages = [2.7777, 5.5555, 8.3333, 11.1111, 13.8888, 16.6666, 13.8888, 11.1111, 8.3333, 5.5555, 2.7777]
        for(var i = 0; i < rollPercentages.length; i++){
          rollPercentages[i] = rollPercentages[i] / 100;
        }

        return Math.round((rollPercentages[number - 2] * totalRolls) * 100) / 100;
      }

      function getAggregatedCounts(allDiceRolls, highestDiceNumber){
        var actuals = [];
        var expecteds = [];

        for (var i = 0; i < highestDiceNumber - 1; i++){
          roll = i + 2;
          actual = numberOfOccurrences(allDiceRolls, roll);
          actuals.push(actual);

          expected = getExpectedCount(roll, allDiceRolls.length)
          expecteds.push(expected);
        }

        return {actuals: actuals, expecteds: expecteds};
      }

      function drawChart(hasLoaded) {
        if (!hasLoaded){
          return;
        }

        agg = getAggregatedCounts(allRolls, high);

        $('#chart').highcharts({
          chart: {
              type: 'column'
          },
          title: {
              text: 'Dice Rolls: Actual vs Expected'
          },
          xAxis: {
              categories: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
          },
          yAxis: {
              title: {
                  text: 'Rolls'
              }
          },
          colors: [
             '#2f7ed8', 
             '#a6c96a'
          ],
          plotOptions: {
              column: {
                  dataLabels: {
                      enabled: true
                  },
                  enableMouseTracking: false
              }
          },
          series: [{
              name: 'Actual',
              data: agg.actuals,
              backgroundColor: '#2DD62D'
          }, {
              name: 'Expected',
              data: agg.expecteds
          }]
        });
      }

      var rootRef = new Firebase('https://catancount.firebaseio.com/');
      var rollsList = new Firebase('https://catancount.firebaseio.com/rolls');

      var hasLoaded = false;
      rollsList.on('value', function(snapshot) {
        hasLoaded = true;
        drawChart(hasLoaded);
      });

      rollsList.on('child_added', function(snapshot) {
        var msgData = snapshot.val();
        $('#output').append(msgData + " ");
        allRolls.push(msgData);

        drawChart(hasLoaded);
      });


      $('.dice-roll').click(function() {
        _this = $(this);
        val = _this.val();
        rollsList.push(val);
      });

    </script>
  </body>
</html>
