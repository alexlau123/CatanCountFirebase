<!DOCTYPE HTML>
<html>
  <head>
    <script src='https://cdn.firebase.com/v0/firebase.js'></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"> </script>
    <script src="http://code.highcharts.com/highcharts.js"></script>

    <link rel="stylesheet" href="bootstrap.min.css">
  </head>
  <body>
    <style>
      .dice-roll{
        width: 50px;
        margin: 10px;
      }
      .dice-roll > h3{
        margin-top: 10px;
      }

    </style>

<nav class="navbar navbar-default" role="navigation">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="#">Dice Roll Stats</a>
  </div>
</nav>

    <div class="row">
      <div id="chart" style="width:95%; padding-left: 10px"></div>
    </div>
    <div class="col-sm-11">
      <div class="col-sm-1 col-sm-offset-1">
        <button class="btn btn-info btn-large dice-roll" value="2" type="button"><h3>2</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="3" type="button"><h3>3</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="4" type="button"><h3>4</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="5" type="button"><h3>5</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="6" type="button"><h3>6</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="7" type="button"><h3>7</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="8" type="button"><h3>8</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="9" type="button"><h3>9</h3></button>
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="10" type="button"><h3>10</h3></button>      
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="11" type="button"><h3>11</h3></button>      
      </div>
      <div class="col-sm-1">
        <button class="btn btn-info btn-large dice-roll" value="12" type="button"><h3>12</h3></button>      
      </div>
    </div>


    <script>
      var allRolls = [];
      var aggregatedRolls = [];
      var high = 12;

      function numberOfOccurrences(arr, num){
        count = 0;

        for (var i = 0; i < arr.length; i++){
          if (arr[i] == num){
            count++;
          }
        }

        return count;
      }

      function getExpectedCount(number, totalRolls){
        rollPercentages = [2.7777, 5.5555, 8.3333, 11.1111, 13.8888, 16.6666, 13.8888, 11.1111, 8.3333, 5.5555, 2.7777]
        for(var i = 0; i < rollPercentages.length; i++){
          rollPercentages[i] = rollPercentages[i] / 100;
        }

        return Math.round((rollPercentages[number - 2] * totalRolls) * 100) / 100;
      }

      function getAggregatedCounts(allDiceRolls, highestDiceNumber){
        var actuals = [];
        var expecteds = [];

        for (var i = 0; i < highestDiceNumber - 1; i++){
          roll = i + 2;
          actual = numberOfOccurrences(allDiceRolls, roll);
          actuals.push(actual);

          expected = getExpectedCount(roll, allDiceRolls.length)
          expecteds.push(expected);
        }

        return {actuals: actuals, expecteds: expecteds};
      }

      function drawChart(hasLoaded) {
        if (!hasLoaded){
          return;
        }

        agg = getAggregatedCounts(allRolls, high);

        $('#chart').highcharts({
          chart: {
              type: 'column'
          },
          title: {
              text: 'Dice Rolls: Actual vs Expected'
          },
          xAxis: {
              categories: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12']
          },
          yAxis: {
              title: {
                  text: 'Rolls'
              }
          },
          colors: [
             '#2f7ed8', 
             '#a6c96a'
          ],
          plotOptions: {
              column: {
                  dataLabels: {
                      enabled: true
                  },
                  enableMouseTracking: false
              }
          },
          series: [{
              name: 'Actual',
              data: agg.actuals,
              backgroundColor: '#2DD62D'
          }, {
              name: 'Expected',
              data: agg.expecteds
          }]
        });
      }

      var rootRef = new Firebase('https://catancount.firebaseio.com/');
      var usersRef = rootRef.child('users');
      var gamesRef = usersRef.child('games');
      var rollsRef = gamesRef.child('rolls');

      var hasLoaded = false;
      rollsRef.on('value', function(snapshot) {
        hasLoaded = true;
        drawChart(hasLoaded);
      });

      rollsRef.on('child_added', function(snapshot) {
        var msgData = snapshot.val();
        $('#output').append(msgData + " ");
        allRolls.push(msgData);

        drawChart(hasLoaded);
      });


      $('.dice-roll').click(function() {
        _this = $(this);
        val = _this.val();
        rollsRef.push(val);
      });

    </script>
  </body>
</html>
